<!DOCTYPE html>
<html>

<head>
  <title>Interface to Walkerbot</title>

  <script type="text/javascript" src="three.js"></script>
  <script type="text/javascript" src="eventemitter2.min.js"></script>
  <script type="text/javascript" src="roslib.js"></script>
  <script type="text/javascript" src="ros3d.js"></script>
  <script type="text/javascript" src="Chart.bundle.min.js"></script>
  <script type="text/javascript" src="mjpegcanvas.js"></script>

  <script type="text/javascript">
    var ros;
    var twist;
    var twistMsg;
    var motorSpeed;
    var turnSpeed;
    var moveDuration;

    function init() {

      // Connects to ROS.
      var url = 'ws://' + document.getElementById('hostname').value + ':9090'
      ros = new ROSLIB.Ros({
        url : url
      });

      function closeSession() {
        console.log("Closing connections.");
        ros.disconnect();
        return false;
      }

      window.onbeforeunload = closeSession;

      ros.on('error', function(error) {
        console.log('ROS Master:  Error, check console.');
        //printProperties(error);
        document.getElementById('statusMessage').innerHTML = '<p>Error detected; check console.</p>';
      });

      ros.on('connection', function() {
        console.log('ROS Master:  Connected.');
        //printProperties(error);
        document.getElementById('statusMessage').innerHTML = "<p style='color:green'>Connected!</p>";
      });

      ros.on('close', function() {
        console.log('ROS Master:  Connection closed.');
        //printProperties(error);
        document.getElementById('statusMessage').innerHTML = "<p style='color:red'>Connection closed.</p>";
      });

      twistpub = new ROSLIB.Topic({
        ros: ros,
        name: '/hcri-walkerbot/twist',
        messageType: 'geometry_msgs/Twist'
      });

      twistMsg = new ROSLIB.Message({});

      imageStream();
    }

    function imageStream() {
      var image = document.getElementById('cameraImage');
      image.src = "http://" + document.getElementById('hostname').value + ":8080/stream?topic=/raspicam_node/image_raw&quality=70";
    }
  </script>
</head>

<body onload="init()">

  <h2>Walkerbot Interface</h2>

  <table summary="hostname" border="1" width=800>
    <tr>
      <td>Hostname: <input type="text" id="hostname" value="192.168.7.2" onchange="init()" /><input type="submit" value="Connect" name="submit" onclick="init()" /></td>
      <td>Connection status:
        <div id="statusMessage">Initial value.</div>
      </td>
    </tr>
  </table>

  <table summary="parameters" border="1" width=800>
    <tr>
      <td>
        <i> Initial Parameters (set before continuing) </i>
        <br/><br/> Motor Speed: <input type="text" id="motorSpeedID" onchange="setMotorSpeed()" /><input type="submit" value="Set" name="submit" onclick="setMotorSpeed()" />
        <br/> Turn Speed: <input type="text" id="turnSpeedID" onchange="setTurnSpeed()" /><input type="submit" value="Set" name="submit" onclick="setTurnSpeed()" />
        <br/> Move Duration: <input type="text" id="moveDurationID" onchange="setMoveDuration()" /><input type="submit" value="Set" name="submit" onclick="setMoveDuration()" />
      </td>
    </tr>


    <td>
      <i> Keyboard Control </i>
      <br/>

      <ul>
        <li>spacebar = Turn Off Motors </li>
        <li>w = Move Forwards </li>
        <li>s = Move Backwards </li>
        <li>a = Turn Left </li>
        <li>d = Turn Right </li>
      </ul>

      <b> Input Box: </b>

      <input type="text" name="keyboardCtrl" value="" onkeydown="keyDown()" onkeyup="keyUp()" onkeypress="keyPress()"/>

      <script type="text/javascript">
        function setMotorSpeed() {
          motorSpeed = document.getElementById('motorSpeedID').value;
          console.log(motorSpeed);
        }

        function setTurnSpeed() {
          turnSpeed = document.getElementById('turnSpeedID').value;
        }

        function setMoveDuration() {
          moveDuration = document.getElementById('moveDurationID').value;
        }

        function publishTurnMotorsOff() {
          console.log("motors turned off");
          twistMsg.linear.x = 0
          twistMsg.angular.z = 0
          twistpub.publish(twistMsg);
        }

        function publishMoveForwards() {
          console.log("move forward");
          twistMsg.linear.x = motorSpeed
          twistpub.publish(twistMsg);
        }

        function publishMoveBackwards() {
          console.log("move backwards");
          twistMsg.linear.x = (-1) * motorSpeed
          twistpub.publish(twistMsg);
        }

        function publishTurnLeft() {
          console.log("turn left");
          twistMsg.angular.z = turnSpeed
          twistpub.publish(twistMsg);
        }

        function publishTurnRight() {
          console.log("turn right");
          twistMsg.angular.z = (-1)*turnSpeed
          twistpub.publish(twistMsg);
        }

        function keyUp() {
          var char = String.fromCharCode(event.which || event.keyCode);
          //console.log("key up: " + char);
          if (char == "W" || char == "A" || char == "S" || char == "D") {
            publishTurnMotorsOff();
          }
        }

        function keyPress() {
          var char = String.fromCharCode(event.which || event.keyCode);
          console.log("key pressed: " + char);
          if (char == ' ') {
            publishTurnMotorsOff();
          }
          event.preventDefault();
          return false;
        }

        function keyDown() {
          //console.log("Got key down: " + event.keyCode);
          var char = String.fromCharCode(event.which || event.keyCode);
          //console.log("Key down: " + char);
          if (char == "W") {
            publishMoveForwards();
          } else if (char == "A") {
            publishTurnLeft();
          } else if (char == "S") {
            publishMoveBackwards();
          } else if (char == "D") {
            publishTurnRight();
          } else {
            //console.log('undefined key: ' + event.keyCode);
          }
        }
      </script>
    </td>

    <tr>
      <td>
        <div id="camera"></div>

        <img id="cameraImage" alt="Camera image" src="nocamera.jpg" width=320/>

      </td>
    </tr>

    <tr>
      <td>Make sure you run <pre>rosrun web_video_server web_video_server</pre> and the image stream.
        <br/> Topic: <input type="text" id="imagetopic" value="/raspicam_node/image_raw" onchange="imageStream()" />
      </td>
    </tr>
  </table>

</body>

</html>
